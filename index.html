import React, { useState, useEffect } from 'react';

// Main App component
const App = () => {
    // State to hold all car entries
    const [carEntries, setCarEntries] = useState([]);
    // Constants for calculations
    const OVERAGE_THRESHOLD = 1500; // This was used for the 10% cap, keeping it for consistency
    const REBATE_MAX_CAP = 1500; // Cap for eligible rebate payment on job total

    // Add a new car entry
    const addCarEntry = () => {
        setCarEntries(prevEntries => [
            ...prevEntries,
            {
                id: prevEntries.length, // Simple unique ID for now
                roNumber: '',
                customerName: '',
                loeNumber: '',
                diagnosticTotal: 0, // New field
                jobTotal: 0,        // New field
                roTotal: 0,         // Now calculated
                eligibleDiagnosticPayment: 0, // New calculated field
                eligibleRebatePayment: 0, // Renamed for clarity, still capped
                customerPayPercentage: 0, // Now based on job total
                overage: 0,
                totalCustomerPayment: 0,
                totalRebatePayment: 0, // New calculated field
            }
        ]);
    };

    // Handle input changes for any car entry
    const handleInputChange = (index, field, value) => {
        setCarEntries(prevEntries => {
            const newEntries = [...prevEntries];
            // Ensure numeric fields are parsed as numbers, others are kept as strings
            newEntries[index] = {
                ...newEntries[index],
                [field]: (field === 'diagnosticTotal' || field === 'jobTotal') ? parseFloat(value) || 0 : value
            };
            return newEntries;
        });
    };

    // Effect to recalculate all values whenever carEntries state changes
    useEffect(() => {
        setCarEntries(prevEntries => {
            return prevEntries.map(car => {
                // Preserve existing car data
                const updatedCar = { ...car };

                const diagnosticTotal = updatedCar.diagnosticTotal || 0;
                const jobTotal = updatedCar.jobTotal || 0;

                // RO Total is now combined
                updatedCar.roTotal = diagnosticTotal + jobTotal;

                // Eligible Diagnostic Payment: 100% of diagnostic total
                updatedCar.eligibleDiagnosticPayment = diagnosticTotal;

                // Eligible Rebate Payment: capped at $1500 of the job total
                updatedCar.eligibleRebatePayment = Math.min(jobTotal, REBATE_MAX_CAP);

                // Customer Pay: 10% of the job total, capped at $150
                updatedCar.customerPayPercentage = Math.min(jobTotal * 0.10, OVERAGE_THRESHOLD * 0.10);

                // Total Rebate Payment: eligible rebate payment + any diagnostic charges
                updatedCar.totalRebatePayment = updatedCar.eligibleRebatePayment + updatedCar.eligibleDiagnosticPayment;

                // Overage: RO Total - Capped 10% - Total Rebate Payment
                const additionalCustomerPayment = updatedCar.roTotal - updatedCar.customerPayPercentage - updatedCar.totalRebatePayment;
                updatedCar.overage = Math.max(0, additionalCustomerPayment);

                // Total Customer Payment: Customer Pay (10%) + Overage
                updatedCar.totalCustomerPayment = updatedCar.customerPayPercentage + updatedCar.overage;

                // Ensure all numeric values are formatted to 2 decimal places
                updatedCar.roTotal = parseFloat(updatedCar.roTotal.toFixed(2));
                updatedCar.eligibleDiagnosticPayment = parseFloat(updatedCar.eligibleDiagnosticPayment.toFixed(2));
                updatedCar.eligibleRebatePayment = parseFloat(updatedCar.eligibleRebatePayment.toFixed(2));
                updatedCar.customerPayPercentage = parseFloat(updatedCar.customerPayPercentage.toFixed(2));
                updatedCar.totalRebatePayment = parseFloat(updatedCar.totalRebatePayment.toFixed(2));
                updatedCar.overage = parseFloat(updatedCar.overage.toFixed(2));
                updatedCar.totalCustomerPayment = parseFloat(updatedCar.totalCustomerPayment.toFixed(2));

                return updatedCar;
            });
        });
    }, [carEntries.map(c => `${c.diagnosticTotal},${c.jobTotal},${c.loeNumber},${c.roNumber},${c.customerName}`).join(','), carEntries.length]); // Re-run when relevant fields change

    // Calculate summary totals
    const totalCarsCount = carEntries.length;
    const grandTotalCustomerPayments = carEntries.reduce((sum, car) => sum + car.totalCustomerPayment, 0);
    const grandTotalEligibleRebatePayments = carEntries.reduce((sum, car) => sum + car.totalRebatePayment, 0); // Sum of new totalRebatePayment
    const grandTotalCombined = grandTotalCustomerPayments + grandTotalEligibleRebatePayments;

    // Initial load: add one car entry
    useEffect(() => {
        if (carEntries.length === 0) {
            addCarEntry();
        }
    }, []); // Run only once on mount

    return (
        <div className="flex flex-col items-center justify-center min-h-screen p-4">
            <div id="rebateFormContainer" className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl border border-gray-700">
                <h1 className="text-3xl font-extrabold text-center text-white mb-8">Mazda's Plus Cool Air Rebate</h1>

                <form className="space-y-6">
                    {/* Container for multiple car entries */}
                    <div id="carEntriesContainer">
                        {carEntries.map((car, index) => (
                            <div key={car.id} className="car-entry" data-car-index={index}>
                                {/* RO NUMBER Field */}
                                <div>
                                    <label htmlFor={`roNumber_${index}`} className="block text-sm font-medium text-gray-300 mb-1">RO NUMBER</label>
                                    <input
                                        type="text"
                                        id={`roNumber_${index}`}
                                        name={`roNumber_${index}`}
                                        placeholder="Enter RO Number"
                                        value={car.roNumber}
                                        onChange={(e) => handleInputChange(index, 'roNumber', e.target.value)}
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                                    />
                                </div>

                                {/* Customer Name Field */}
                                <div className="mt-4">
                                    <label htmlFor={`customerName_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Customer Name</label>
                                    <input
                                        type="text"
                                        id={`customerName_${index}`}
                                        name={`customerName_${index}`}
                                        placeholder="Enter Customer Full Name"
                                        value={car.customerName}
                                        onChange={(e) => handleInputChange(index, 'customerName', e.target.value)}
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                                    />
                                </div>

                                {/* LOE# Field (Text Input) */}
                                <div className="mt-4">
                                    <label htmlFor={`loeNumber_${index}`} className="block text-sm font-medium text-gray-300 mb-1">LOE#</label>
                                    <input
                                        type="text"
                                        id={`loeNumber_${index}`}
                                        name={`loeNumber_${index}`}
                                        placeholder="Enter LOE Number"
                                        value={car.loeNumber}
                                        onChange={(e) => handleInputChange(index, 'loeNumber', e.target.value)}
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                                    />
                                </div>

                                <hr className="border-gray-700 my-4" /> {/* Separator for new fields */}

                                {/* Diagnostic Total Field (New) */}
                                <div className="mt-4">
                                    <label htmlFor={`diagnosticTotal_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Diagnostic Total ($)</label>
                                    <input
                                        type="number"
                                        id={`diagnosticTotal_${index}`}
                                        name={`diagnosticTotal_${index}`}
                                        step="0.01"
                                        min="0"
                                        value={car.diagnosticTotal}
                                        onChange={(e) => handleInputChange(index, 'diagnosticTotal', e.target.value)}
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                                    />
                                </div>

                                {/* Job Total Field (New) */}
                                <div className="mt-4">
                                    <label htmlFor={`jobTotal_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Job Total ($)</label>
                                    <input
                                        type="number"
                                        id={`jobTotal_${index}`}
                                        name={`jobTotal_${index}`}
                                        step="0.01"
                                        min="0"
                                        value={car.jobTotal}
                                        onChange={(e) => handleInputChange(index, 'jobTotal', e.target.value)}
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                                    />
                                </div>

                                {/* RO Total Field (Now calculated and read-only) */}
                                <div className="mt-4">
                                    <label htmlFor={`roTotal_${index}`} className="block text-sm font-medium text-gray-300 mb-1">RO Total (Diagnostic + Job)</label>
                                    <input
                                        type="text"
                                        id={`roTotal_${index}`}
                                        name={`roTotal_${index}`}
                                        value={car.roTotal.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-400 cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                <hr className="border-gray-700 my-4" /> {/* Separator for calculated payments */}

                                {/* Eligible Diagnostic Payment Field (New) */}
                                <div className="mt-4">
                                    <label htmlFor={`eligibleDiagnosticPayment_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Eligible Diagnostic Payment (100% of Diagnostic Total)</label>
                                    <input
                                        type="text"
                                        id={`eligibleDiagnosticPayment_${index}`}
                                        name={`eligibleDiagnosticPayment_${index}`}
                                        value={car.eligibleDiagnosticPayment.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-400 cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                {/* Eligible Rebate Payment (from Job Total) Field */}
                                <div className="mt-4">
                                    <label htmlFor={`eligibleRebatePayment_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Eligible Rebate Payment (from Job Total, Max ${REBATE_MAX_CAP.toFixed(2)})</label>
                                    <input
                                        type="text"
                                        id={`eligibleRebatePayment_${index}`}
                                        name={`eligibleRebatePayment_${index}`}
                                        value={car.eligibleRebatePayment.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-400 cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                {/* Customer Pay (10% of Job Total, capped at $150) Field */}
                                <div className="mt-4">
                                    <label htmlFor={`customerPayPercentage_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Customer Pay (10% of Job Total, Capped at ${(OVERAGE_THRESHOLD * 0.10).toFixed(2)})</label>
                                    <input
                                        type="text"
                                        id={`customerPayPercentage_${index}`}
                                        name={`customerPayPercentage_${index}`}
                                        value={car.customerPayPercentage.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-400 cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                {/* Total Rebate Payment Field (New) */}
                                <div className="mt-4">
                                    <label htmlFor={`totalRebatePayment_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Total Rebate Payment (Eligible Rebate + Eligible Diagnostic)</label>
                                    <input
                                        type="text"
                                        id={`totalRebatePayment_${index}`}
                                        name={`totalRebatePayment_${index}`}
                                        value={car.totalRebatePayment.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-purple-400 font-bold cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                {/* Overage Field */}
                                <div className="mt-4">
                                    <label htmlFor={`overage_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Additional Customer Payment (RO Total - Capped 10% - Total Rebate)</label>
                                    <input
                                        type="text"
                                        id={`overage_${index}`}
                                        name={`overage_${index}`}
                                        value={car.overage.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-gray-400 cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>

                                {/* Total Customer Payment Field */}
                                <div className="mt-4">
                                    <label htmlFor={`totalCustomerPayment_${index}`} className="block text-sm font-medium text-gray-300 mb-1">Total Customer Payment ($)</label>
                                    <input
                                        type="text"
                                        id={`totalCustomerPayment_${index}`}
                                        name={`totalCustomerPayment_${index}`}
                                        value={car.totalCustomerPayment.toFixed(2)}
                                        readOnly
                                        className="mt-1 block w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-green-400 font-bold cursor-not-allowed shadow-sm sm:text-sm"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Button to add another car */}
                    <button
                        type="button"
                        id="addCarBtn"
                        onClick={addCarEntry}
                        className="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                    >
                        Add Another Car
                    </button>

                    <hr className="border-gray-700 my-8" />

                    {/* Summary Section */}
                    <div className="bg-gray-700 p-6 rounded-xl shadow-inner border border-gray-600">
                        <h2 className="text-2xl font-bold text-white mb-4">Summary</h2>

                        {/* Car Details List */}
                        <h3 className="text-xl font-bold text-white mt-6 mb-3">Car Details List:</h3>
                        <ul id="carDetailsList" className="space-y-2 text-gray-300 mb-6">
                            {totalCarsCount === 0 ? (
                                <li className="text-sm text-gray-400 italic">No cars added yet.</li>
                            ) : (
                                carEntries.map(car => {
                                    const nameParts = car.customerName.split(' ').filter(part => part !== '');
                                    const displayName = nameParts.length > 1
                                        ? nameParts[nameParts.length - 1]
                                        : nameParts.length === 1
                                            ? nameParts[0]
                                            : `Car ${car.id + 1}`;
                                    return (
                                        <li key={car.id} className="text-gray-200">
                                            <span className="font-medium">{displayName}:</span>{' '}
                                            RO Total: <span className="text-red-400">${car.roTotal.toFixed(2)}</span>,{' '}
                                            Diagnostic Total: <span className="text-red-400">${car.diagnosticTotal.toFixed(2)}</span>,{' '}
                                            Job Total: <span className="text-red-400">${car.jobTotal.toFixed(2)}</span>,{' '}
                                            Eligible Diagnostic Pay: <span className="text-green-400">${car.eligibleDiagnosticPayment.toFixed(2)}</span>,{' '}
                                            Eligible Rebate Pay: <span className="text-green-400">${car.eligibleRebatePayment.toFixed(2)}</span>,{' '}
                                            Total Rebate Pay: <span className="font-bold text-green-400">${car.totalRebatePayment.toFixed(2)}</span>,{' '}
                                            Customer Pay (10% Job): <span className="text-green-400">${car.customerPayPercentage.toFixed(2)}</span>,{' '}
                                            Total Customer Pay: <span className="font-bold text-green-400">${car.totalCustomerPayment.toFixed(2)}</span>
                                            {car.loeNumber ? <span className="ml-2 text-green-400">LOE#: {car.loeNumber}</span> : <span className="ml-2 text-gray-500">(LOE# Not Entered)</span>}
                                        </li>
                                    );
                                })
                            )}
                        </ul>

                        {/* Summary Totals */}
                        <div className="space-y-3 pt-4 border-t border-gray-600">
                            <p className="text-lg text-gray-200">Total Number of Cars: <span id="totalCarsCount" className="font-bold text-xl text-blue-400">{totalCarsCount}</span></p>
                            <p className="text-lg text-gray-200">Grand Total Customer Payments: <span id="grandTotalPayments" className="font-bold text-xl text-green-400">${grandTotalCustomerPayments.toFixed(2)}</span></p>
                            <p className="text-lg text-gray-200">Total Eligible Rebate Payments: <span id="totalEligibleRebatePayments" className="font-bold text-xl text-green-400">${grandTotalEligibleRebatePayments.toFixed(2)}</span></p>
                            <p className="text-lg text-gray-200">Grand Total: <span id="grandTotalCombined" className="font-bold text-xl text-green-400">${grandTotalCombined.toFixed(2)}</span></p>
                        </div>
                    </div>

                    {/* Submit Button - Note: html2canvas functionality is omitted in this React simulation */}
                    <button
                        type="submit"
                        id="submitRebateBtn"
                        onClick={(e) => { e.preventDefault(); alert("Submit functionality (image capture) is omitted in this React simulation."); }}
                        className="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out mt-8"
                    >
                        Submit All Rebates
                    </button>
                </form>
            </div>
        </div>
    );
};

export default App;
